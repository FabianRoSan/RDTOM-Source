set -e

sudo ./run_phpunit_tests

echo "PHP Unit tests completed"

sudo ./copy_files_to_localhost

echo "Files copied to localhost"

echo "~~~~~~~~~~~~~~~~~~~~~~~~~"
echo "Running Mocha Acceptance tests"
echo "~~~~~~~~~~~~~~~~~~~~~~~~~"

sudo service apache2 restart
sudo service mysql restart

echo "Dropping and re-populating local database"
mysql -u root -e "drop database rdtom_local"; 
mysql -u root -e "create database rdtom_local"; 
mysql -u root rdtom_local < tests/acceptance/sample.sql

mocha tests/acceptance/tests/ --recursive --ui tdd --reporter spec --timeout 60000 --bail

sudo /etc/init.d/apache2 stop

if [ $# -gt 0  ]; then
	MESSAGE="$@"
	echo "Committing with message '$MESSAGE'"
	git pull
	git add -A
	git commit -am "$MESSAGE"
	git push
else
  echo "No commit message, no commit"
fi