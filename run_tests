set -e

echo "~~~~~~~~~~~~~~~~~~~~~~~~~"
echo "Running PHP Unit tests"
echo "~~~~~~~~~~~~~~~~~~~~~~~~~"


for D in tests/unit/*; do
    if [ -f "${D}" ]; then
			DIR="$D.php"
			echo "testing $DIR"
			phpunit $DIR
	fi
done

echo "PHP Unit tests completed"

echo "Copying files"
sudo cp -rf ./* /var/
echo "renaming html to www"
sudo cp -rf /var/html/* /var/www/

sudo /etc/init.d/apache2 restart

echo "~~~~~~~~~~~~~~~~~~~~~~~~~"
echo "Running Mocha Acceptance tests"
echo "~~~~~~~~~~~~~~~~~~~~~~~~~"

mocha tests/acceptance/tests/ --recursive --ui tdd --reporter spec --timeout 60000 --bail

sudo /etc/init.d/apache2 stop

if [ $# -gt 0  ]; then
	MESSAGE="$@"
	echo "Committing with message '$MESSAGE'"
	git pull
	git add -A
	git commit -am "$MESSAGE"
	git push
else
  echo "No commit message, no commit"
fi